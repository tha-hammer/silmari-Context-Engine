# BAML Integration TDD Implementation - Overview

## Summary

Integrate BAML (Boundary AI Markup Language) into the Context Engine to replace regex-based output parsing with type-safe, schema-driven LLM function calls using Approach A (Hybrid): Keep Claude CLI subprocess for execution, use BAML for structured parsing of text output.

## Phase Links

| Phase | Title | Dependencies | Human-Testable Function |
|-------|-------|--------------|------------------------|
| [Phase 1](2026-01-01-ENG-XXXX-tdd-baml-integration-01-project-setup.md) | Project Setup | None | `baml-cli --version` and `pip install -e .` |
| [Phase 2](2026-01-01-ENG-XXXX-tdd-baml-integration-02-schema-definitions.md) | Schema Definitions | Phase 1 | `from baml_client.types import ResearchOutput, PlanOutput, Phase` |
| [Phase 3](2026-01-01-ENG-XXXX-tdd-baml-integration-03-baml-functions.md) | BAML Parse Functions | Phase 2 | `b.ParseResearchOutput(raw_output="...")` returns typed data |
| [Phase 4](2026-01-01-ENG-XXXX-tdd-baml-integration-04-helper-integration.md) | Helper Integration | Phase 3 | `parse_research_output(text)` returns `ResearchOutput` |
| [Phase 5](2026-01-01-ENG-XXXX-tdd-baml-integration-05-steps-integration.md) | Steps Integration | Phase 4 | `step_research()` returns typed `ResearchStepResult` |
| [Phase 6](2026-01-01-ENG-XXXX-tdd-baml-integration-06-full-pipeline.md) | Full Pipeline | Phase 5 | `BAMLPlanningPipeline.run()` returns `PipelineResult` with IDE autocomplete |

## Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                       BAMLPlanningPipeline                          │
│                                                                     │
│  ┌───────────────┐    ┌───────────────┐    ┌────────────────────┐  │
│  │  step_research │    │  step_planning │    │ step_decomposition │  │
│  │  (baml_steps)  │    │  (baml_steps)  │    │   (baml_steps)     │  │
│  └───────┬───────┘    └───────┬───────┘    └─────────┬──────────┘  │
│          │                    │                       │             │
│          ▼                    ▼                       ▼             │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                      baml_helpers.py                           │ │
│  │   parse_research_output()  parse_plan_output()  parse_phase_files() │
│  └───────────────────────────────────────────────────────────────┘ │
│          │                    │                       │             │
│          ▼                    ▼                       ▼             │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                      baml_client (b)                           │ │
│  │  b.ParseResearchOutput()  b.ParsePlanOutput()  b.ParsePhaseFiles() │
│  └───────────────────────────────────────────────────────────────┘ │
│          │                    │                       │             │
│          ▼                    ▼                       ▼             │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                        baml_src/                               │ │
│  │     schemas.baml (types)     functions.baml (LLM calls)        │ │
│  └───────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

## Key Files

### New Files to Create
- `pyproject.toml` - Python dependencies with baml-py
- `baml_src/main.baml` - Generator configuration
- `baml_src/clients.baml` - LLM client definitions
- `baml_src/schemas.baml` - Type definitions
- `baml_src/functions.baml` - Parsing functions
- `planning_pipeline/baml_helpers.py` - BAML wrapper functions
- `planning_pipeline/baml_steps.py` - Typed step implementations
- `planning_pipeline/baml_pipeline.py` - Full pipeline with types
- `baml_client/` - Auto-generated by `baml-cli generate`

### Existing Files (Modified)
- None (new modules are additive)

### Test Files
- `planning_pipeline/tests/test_baml_setup.py` - Phase 1
- `planning_pipeline/tests/test_baml_schemas.py` - Phase 2
- `planning_pipeline/tests/test_baml_functions.py` - Phase 3
- `planning_pipeline/tests/test_baml_helpers.py` - Phase 4
- `planning_pipeline/tests/test_baml_steps.py` - Phase 5
- `planning_pipeline/tests/test_baml_errors.py` - Phase 5
- `planning_pipeline/tests/test_baml_pipeline.py` - Phase 6

## Success Criteria (End State)

1. **Type Safety**: All pipeline outputs return typed dataclasses, not `dict[str, Any]`
2. **IDE Support**: Full autocomplete for all result fields
3. **Test Coverage**: All 12 behaviors have passing tests
4. **Error Handling**: Graceful failures with descriptive errors
5. **Backwards Compatibility**: Original `steps.py` and `helpers.py` remain functional

## Complexity Estimate

Medium - Most work is configuration and new code, minimal risk to existing functionality.

## References

- Source Plan: `thoughts/shared/plans/2026-01-01-tdd-baml-integration.md`
- Research: `thoughts/shared/research/2026-01-01-baml-integration-research.md`
- BAML Docs: https://docs.boundaryml.com/home
